#!/bin/bash
# Kibana enrollment automation script
# Generated by Ansible on {{ ansible_date_time.date }}

set -e

echo "Starting Kibana enrollment automation..."

# Variables from Ansible
KIBANA_HOST="localhost"
KIBANA_PORT="{{ kibana_port }}"
ENROLLMENT_TOKEN="{{ kibana_token }}"
VERIFICATION_CODE="{{ kibana_code }}"
ELASTIC_PASSWORD="{{ elasticsearch_password }}"

# Wait for Kibana to be ready
echo "Waiting for Kibana to be ready..."
for i in {1..30}; do
  if curl -s http://${KIBANA_HOST}:${KIBANA_PORT}/api/status > /dev/null; then
    echo "Kibana is up and running"
    break
  fi
  
  if [ $i -eq 30 ]; then
    echo "Timeout waiting for Kibana to start. Proceeding anyway..."
  fi
  
  echo "Waiting for Kibana to start... (${i}/30)"
  sleep 10
done

# Step 1: Submit enrollment token via API
echo "Submitting enrollment token..."

# Use expect to automate the enrollment process
/usr/bin/expect <<EOF
set timeout 120

# First call the enrollment API
spawn curl -k -X POST -H "Content-Type: application/json" -H "kbn-xsrf: true" https://${KIBANA_HOST}:${KIBANA_PORT}/internal/cloud_setup/enrolled_instance/complete_enrollment -d '{"token":"${ENROLLMENT_TOKEN}"}'

expect {
  "verification_code" {
    puts "\nEnrollment token accepted, proceeding to verification code..."
  }
  timeout {
    puts "\nTimeout waiting for enrollment response"
    exit 1
  }
}
EOF

echo "Enrollment token submitted successfully"
sleep 5

# Step 2: Submit verification code
echo "Submitting verification code..."

/usr/bin/expect <<EOF
set timeout 120

# Submit verification code
spawn curl -k -X POST -H "Content-Type: application/json" -H "kbn-xsrf: true" https://${KIBANA_HOST}:${KIBANA_PORT}/internal/cloud_setup/verification_code -d '{"verificationCode":"${VERIFICATION_CODE}"}'

expect {
  "success" {
    puts "\nVerification code accepted!"
  }
  timeout {
    puts "\nTimeout waiting for verification response"
    exit 1
  }
}
EOF

echo "Verification code submitted successfully"

# Wait for Kibana to fully initialize after enrollment
echo "Waiting for Kibana to complete initialization..."
sleep 30

echo "Kibana enrollment completed successfully!"
exit 0