#!/bin/bash
# Kibana enrollment script created by Ansible
# Generated on: {{ ansible_date_time.date }}

set -e

KIBANA_TOKEN="{{ kibana_token }}"
KIBANA_BIN="/usr/share/kibana/bin"

echo "Starting Kibana enrollment with Elasticsearch..."

# Stop Kibana service if running
if systemctl is-active --quiet kibana; then
  echo "Stopping Kibana service temporarily..."
  systemctl stop kibana
fi

# Execute enrollment
echo "Running enrollment command with token..."
# Fix for command syntax - explicitly specify the enrollment token argument
$KIBANA_BIN/kibana-setup --enrollment-token "${KIBANA_TOKEN}"

echo "Kibana has been enrolled with Elasticsearch successfully!"
echo "Starting Kibana service again..."
systemctl start kibana

echo "Waiting for Kibana to start..."
for i in {1..12}; do
  if curl -s http://localhost:5601 > /dev/null; then
    echo "Kibana started successfully!"
    exit 0
  fi
  
  echo "Waiting for Kibana to start... ($i/12)"
  sleep 10
done

echo "Kibana enrollment completed, but service may still be starting."