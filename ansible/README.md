# ELK Stack Ansible Configuration

This directory contains Ansible playbooks and roles for deploying and configuring the Elastic Stack (ELK) components:

- **Elasticsearch**: Distributed search and analytics engine
- **Logstash**: Data processing pipeline
- **Kibana**: Data visualization dashboard
- **Filebeat**: Lightweight log shipper

## Directory Structure

```
ansible/
├── ansible.cfg             # Ansible configuration settings
├── install-elk.yml         # Main playbook for ELK stack deployment
├── inventory/              # Server inventory files
│   ├── elk.ini             # Active inventory (generated by Terraform)
│   └── elk.ini.example     # Example inventory for reference
└── roles/                  # Component-specific roles
    ├── elasticsearch/      # Elasticsearch configuration
    ├── kibana/             # Kibana configuration
    ├── logstash/           # Logstash configuration
    └── filebeat/           # Filebeat configuration
```

## Usage

### Running the Full Playbook

To deploy the entire ELK stack:

```bash
cd /path/to/elk-stack-setup
./deploy-elk-stack.sh
```

### Running Ansible Directly

To run only the Ansible configuration (if infrastructure already exists):

```bash
cd /path/to/elk-stack-setup
./deploy-elk-stack.sh -a
```

### Deploying Specific Components

To deploy only specific components using the deployment script:

```bash
cd /path/to/elk-stack-setup
./deploy-elk-stack.sh -a -t elasticsearch,kibana
```

### Running Ansible Playbook Directly with Tags

For DevOps engineers who prefer to run Ansible playbooks directly:

```bash
# Navigate to the ansible directory
cd /path/to/elk-stack-setup/ansible

# Run specific components only
ansible-playbook install-elk.yml -t elasticsearch,kibana

# Run specific components with verbosity for debugging
ansible-playbook install-elk.yml -t elasticsearch -vv

# Run playbook on specific hosts
ansible-playbook install-elk.yml -t kibana -l elasticsearch_master

# Check syntax only (dry run)
ansible-playbook install-elk.yml --syntax-check

# Run with diff to see configuration changes
ansible-playbook install-elk.yml -t elasticsearch --diff
```

Available tags:
- `elasticsearch`
- `kibana`
- `logstash`
- `filebeat`

## Inventory File

The inventory file (`inventory/elk.ini`) defines the hosts for each component of the ELK stack. This file is typically generated by Terraform but can be manually created if necessary.

The inventory file should contain:

- `[elasticsearch_master]`: Master node(s) for Elasticsearch cluster
- `[elasticsearch_data]`: Data node(s) for Elasticsearch cluster
- `[logstash]`: Logstash instances
- `[filebeat]`: Hosts where Filebeat will be installed

## Modifying Configurations

Each role contains:

- `defaults/main.yml`: Default variables that can be overridden
- `vars/`: Component-specific variables 
- `templates/`: Configuration templates using Jinja2 format
- `tasks/main.yml`: Installation and configuration tasks
- `handlers/main.yml`: Event handlers (e.g., for service restarts)

## Security Notes

- Elasticsearch security is enabled by default (X-Pack)
- SSL is configured for HTTP API access
- Default credentials are set during installation and can be found at `/etc/elasticsearch/elastic_credentials.txt` on the master node
- Certificate files are automatically distributed to all nodes

## Troubleshooting

Common issues:

1. **Connection failures**: Check SSH key configuration and network connectivity
2. **Failed enrollment**: Verify that Elasticsearch master node is fully initialized before data nodes join
3. **Certificate errors**: Ensure CA certificates are properly distributed to all nodes

For other issues, check logs:
- Elasticsearch: `/var/log/elasticsearch/elasticsearch.log`
- Kibana: `/var/log/kibana/kibana.log`
- Logstash: `/var/log/logstash/logstash-plain.log`
- Filebeat: `/var/log/filebeat/filebeat`